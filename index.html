<!DOCTYPE html>
<html lang="en" ng-app="addicted">
<head>
    <meta charset="UTF-8">
    <title>Чятик</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        .link-this:hover {
            cursor: pointer;
            color: red;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>Chat addicted!<small>by brain5ur9ery</small></h1>
    </div>
    <chat></chat>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.6.4/angular-sanitize.min.js"></script>
<script>
    angular.module('addicted', ['ngSanitize'])
        .directive('chat', function () {
            return {
                controller: function ($scope, socket) {
                    var myNick = undefined;
                    $scope.entered = false;
                    $scope.enterToChat = function (nick) {
                        myNick = nick;
                        $scope.entered = true;
                        socket.emit('hello', { nick: nick })
                    };
                    socket.init('http://192.168.88.13:8000');

                    socket.on('server:stored-messages',function (data) {
                        console.log(data);
                        for(var i =0; i < data.listof.length; i++){
                            $scope.messages.push(data.listof[i])
                        }

                    });

                    $scope.users = undefined;
                    socket.on('hello:error', function (data) {
                        alert(data.data);
                        $scope.entered = false;
                    });
                    socket.on('server:hello', function (users) {
                        console.log(users);
                        $scope.users = users.users;
                    });
                    $scope.messages = [];
                    var options = {
                        era: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long',
                        timezone: 'UTC',
                        hour: 'numeric',
                        minute: 'numeric',
                        second: 'numeric'
                    };
                    socket.on('s:mess', function (data) {
                        var date = new Date().toLocaleDateString('ru', options);
                        date = date.substring(date.length-8);
                        data.date = date;
                                $scope.messages.push(data);
                                console.log('Общее ' + data)
                    });
                    socket.on('message',function (data) {
                        var date = new Date().toLocaleDateString('ru', options);
                        date = date.substring(date.length-8);
                        data.date = date;
                            $scope.messages.push(data);
                            console.log('Общее ' + data)
                        });
                    $scope.send = function (mess) {
                            socket.emit('mess', { nick: myNick, data: mess});
                            $scope.i_message = '';
                    };
                },
                templateUrl: 'chat.html'
            }
        })
        .factory('socket',function ($rootScope){
            var socket;
            return {
                init: function (url) {
                    socket = io(url);
                },
                on: function (eventName,callback){
                    socket.on(eventName,function(){
                        var args = [].slice.call(arguments);
                        $rootScope.$apply(function(){
                            if(callback){
                                callback.apply(socket,args);
                            }
                        });
                    });
                },
                emit: function (eventName, data, callback){
                    var args = [].slice.call(arguments), cb;
                    if( typeof args[args.length-1]  == "function" ){
                        cb = args[args.length-1];
                        args[args.length-1] = function(){
                            var args = [].slice.call(arguments);
                            $rootScope.$apply(function(){
                                if(cb){
                                    cb.apply(socket,args);
                                }
                            });
                        };
                    }
                    socket.emit.apply(socket, args);
                }
            };
        })
</script>
<script type="text/ng-template" id="chat.html">
    <div>
        <form class="form-inline" name="FormReg">
            <div class="form-group">
                <input ng-model="nick" ng-disabled="entered" class="form-control" placeholder="Ваш ник" required>
                <button ng-click="enterToChat(nick)" ng-disabled="entered || FormReg.$invalid" class="btn btn-primary">Войти</button>
            </div>
        </form>
        <span ng-if="!entered">Войди в чат, чтобы увидеть кто там есть</span>
        <span ng-if="entered">Сейчас в чате:</span>
        <span ng-if="entered" ng-repeat="user in users">{{user}}<span ng-if="!$last">,</span>
            <span ng-if="$last">.</span>
        </span>
    </div>
    <div>
        <div style="margin-bottom: 10px">
            <div style="overflow-y: scroll; min-height: 600px ;max-height: 600px; border: solid 1px #9e9e9e">
                <div ng-repeat="m in messages">
                    <div>
                        <span>
                            <b>{{m.date}} </b>
                        </span>
                        <b>Пользователь</b>
                        <span class="link-this">
                            {{m.nick}}
                        </span>  <b>написал:</b>
                        <span ng-bind-html="m.data">
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-left: 30px">
            <form name="f" class="form-inline">
                <div class="form-group">
                    <input ng-model="i_message" required id="mbody" size="100" class="form-control" placeholder="Сообщение">
                    <input type="submit" ng-click="send(i_message)" value="Отправить!" ng-disabled="f.$invalid || !entered" class="btn btn-default"/>
                </div>
            </form>
        </div>
    </div>
</script>
</body>
</html>