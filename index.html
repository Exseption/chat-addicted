<!DOCTYPE html>
<html lang="en" ng-app="addicted">
<head>
    <meta charset="UTF-8">
    <title>Чятик</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular.min.js"></script>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        .link-this:hover {
            cursor: pointer;
            color: red;
        }

        html, body {
            max-width: 100% !important;
            overflow-x: hidden !important;
        }
    </style>
</head>
<body>
<chat></chat>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.6.4/angular-sanitize.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular-cookies.js"></script>
<script>
    angular.module('addicted', ['ngSanitize', 'ngCookies'])
        .directive('chat', function (socket, $sce, $timeout, $cookies, $window) {
            return {
                templateUrl: 'chat.html',
                link: function (scope, elem, attrs) {
                    var myNick = undefined;
                    scope.entered = false;
                    socket.init('http://192.168.88.13:8000'); //init url
                    scope.enterToChat = function (nick, chk) {
                        if(chk){
                            $cookies.put('user', nick);
                        }
                        myNick = nick;
                        scope.entered = true;
                        socket.emit('hello', { nick: nick })
                    };
                    if($cookies.get('user')){
                        var user = $cookies.get('user');
                        scope.enterToChat(user, null);

                    }
                    scope.forgiveMe = function () {
                      $cookies.remove('user');
                      $window.location.reload();
                    };
                    var keying = '';
                    socket.on('server:keying', function (data) {
                        scope.keying = 'Пользователь ' + data.nick + ' ' + data.action;
                        $timeout(function () {
                            scope.keying = '';
                        }, 1000)
                    });

                    angular.element(document.querySelector('#message_body'))
                        .bind('keydown keypress', function (event) {
                            socket.emit('keying', {nick: myNick})
                        });
                    const scroll = function () {
                        return $timeout(function() {
                            var scroller = document.getElementById("chatDiv");
                            scroller.scrollTop = scroller.scrollHeight;
                        }, 0, false);
                    };

                    socket.on('server:stored-messages',function (data) {
                        console.log(data);
                        for(var i =0; i < data.listof.length; i++){
                            scope.messages.push(data.listof[i])
                        }
                        scroll();
                    });
                    scope.users = undefined;
                    socket.on('hello:error', function (data) {
                        alert(data.data);
                        scope.entered = false;
                    });
                    socket.on('server:hello', function (users) {
                        console.log(users);
                        scope.users = users.users;
                    });
                    scope.messages = [];
                    var options = {
                        era: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long',
                        timezone: 'UTC',
                        hour: 'numeric',
                        minute: 'numeric',
                        second: 'numeric'
                    };
                    socket.on('s:mess', function (data) {
                        var date = new Date().toLocaleDateString('ru', options);
                        date = date.substring(date.length-8);
                        data.date = date;
                        scope.messages.push(data);
                        console.log('Общее ' + data);
                        scroll();
                    });
                    socket.on('message',function (data) {
                        var date = new Date().toLocaleDateString('ru', options);
                        date = date.substring(date.length-8);
                        data.date = date;
                        scope.messages.push(data);
                        console.log('Общее ' + data);
                        scroll();

                    });
                    scope.send = function (mess) {
                        socket.emit('mess', { nick: myNick, data: mess});
                        scope.i_message = '';
                        scroll();
                    };
                }
            }
        })
        .filter('unsafe', function($sce) {
            return $sce.trustAsHtml; })
        .filter('fuckNick', function () {
            return function (nick) {
                return nick.substring(0,10) + '...';
            }
        })
        .factory('socket',function ($rootScope){
            var socket;
            return {
                init: function (url) {
                    socket = io(url);
                },
                on: function (eventName,callback){
                    socket.on(eventName,function(){
                        var args = [].slice.call(arguments);
                        $rootScope.$apply(function(){
                            if(callback){
                                callback.apply(socket,args);
                            }
                        });
                    });
                },
                emit: function (eventName, data, callback){
                    var args = [].slice.call(arguments), cb;
                    if( typeof args[args.length-1]  == "function" ){
                        cb = args[args.length-1];
                        args[args.length-1] = function(){
                            var args = [].slice.call(arguments);
                            $rootScope.$apply(function(){
                                if(cb){
                                    cb.apply(socket,args);
                                }
                            });
                        };
                    }
                    socket.emit.apply(socket, args);
                }
            };
        })
</script>
<script type="text/ng-template" id="chat.html">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="container">
                <div class="navbar-header">
                    <div class="navbar-brand" href="#">
                        <img alt="Brand" src="https://cdn0.iconfinder.com/data/icons/pokemon-go-vol-2/135/_pikachu-32.png" style="    margin-top: -5px;"></div>
                    </div>
                    <form class="navbar-form navbar-left" name="FormReg">
                        <div class="form-group">
                            <input ng-model="nick" ng-disabled="entered" class="form-control" placeholder="Ваш ник" required>
                            <div class="checkbox" style="margin-left: 5px">
                                <label>
                                    <input type="checkbox" ng-disabled="entered || FormReg.$invalid" ng-model="chk"> Запомнить меня
                                </label>
                            </div>
                            <button ng-click="enterToChat(nick, chk)" ng-disabled="entered || FormReg.$invalid" class="btn btn-danger">Войти</button>
                            <button class="btn btn-primary" ng-disabled="!entered" ng-click="forgiveMe()">Выйти и забыть!</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <div>
            <span ng-if="!entered">Войди в чат, чтобы увидеть кто там есть</span>
            <span ng-if="entered">Сейчас в чате:</span>
            <span ng-if="entered" ng-repeat="user in users">{{user | fuckNick}}<span ng-if="!$last">,</span>
            <span ng-if="$last">.</span>
        </span>
        </div>
        <div>
            <div style="margin-bottom: 10px" >
                <div style="overflow-y: scroll; min-height: 600px ;max-height: 600px; border: solid 1px #9e9e9e;" id="chatDiv">
                    <div ng-repeat="m in messages" >
                        <div>
                        <span>
                            <b>{{m.date}} </b>
                        </span>
                            <b>Пользователь</b>
                            <span class="link-this">
                            {{m.nick}}
                        </span>  <b>написал:</b>
                            <div ng-bind-html="m.data | unsafe">
                        </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-left: 30px">
                <div style="min-height: 2em"><i>{{keying}}</i></div>
                <form name="f" class="form-inline">
                    <div class="form-group">
                        <input ng-model="i_message" required id="message_body" size="100" class="form-control" placeholder="Сообщение">
                        <input type="submit" ng-click="send(i_message)" value="Отправить!" ng-disabled="f.$invalid || !entered" class="btn btn-primary"/>
                    </div>
                </form>
            </div>
        </div>
    </div>
</script>
</body>
</html>